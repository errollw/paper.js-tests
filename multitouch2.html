<!DOCTYPE html>
<html>
<head>
<!-- Load the Paper.js library -->
<script type="text/javascript" src="js/paper.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<!-- Define inlined JavaScript -->
<script type="text/javascript">

  // Make the paper scope global, by injecting it into window:
  paper.install(window);

  // Keep track of on-going touches
  var ongoingTouches = new Array;

  var grab_pt_1, grab_pt_2; 

  var raster;

  // Only executed our code once the DOM is ready.
  window.onload = function() {

    // Create an empty project and a view for the canvas
    var canvas = document.getElementById('myCanvas');
    paper.setup(canvas);

    // Create a raster item using the image tag with id='mona'
    raster = new Raster('test_img');

    // Move the raster to the center of the view
    raster.position = view.center;

    raster.originalWidth = raster.width;
    raster.originalHeight = raster.height;
    raster.originalPosition = raster.position;

    var el = document.getElementsByTagName("canvas")[0];
    el.addEventListener("touchstart", handleStart, false);
    el.addEventListener("touchend", handleEnd, false);
    el.addEventListener("touchcancel", handleCancel, false);
    el.addEventListener("touchleave", handleEnd, false);
    el.addEventListener("touchmove", handleMove, false);
    console.log("initialized.");

  }

  function handleStart(evt) {
    evt.preventDefault();
    var touches = evt.changedTouches;
          
    for (var i=0; i < touches.length; i++) {
      ongoingTouches.push(copyTouch(touches[i]));
      prevTouches.push(copyTouch(touches[i]));

      // if (ongoingTouches.length == 1){
      //   grab_pt_1 = new Point(ongoingTouches[0].pageX, ongoingTouches[0].pageY);
      // }

      // if (ongoingTouches.length == 2){
      //   grab_pt_1 = new Point(ongoingTouches[0].pageX, ongoingTouches[0].pageY);
      //   grab_pt_2 = new Point(ongoingTouches[1].pageX, ongoingTouches[1].pageY);
      // }
    }
  }

  var prevTouches = []; 

  function handleMove(evt) {
    evt.preventDefault();
    var touches = evt.changedTouches;

    raster.selected = true;

    for (var i=0; i < touches.length; i++) {
      var idx = ongoingTouchIndexById(touches[i].identifier);

      if(idx >= 0) {
        prevTouches[idx] = ongoingTouches[idx] ? copyTouch(ongoingTouches[idx]) : copyTouch(touches[i]);
        ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
      } else {
        console.log("can't figure out which touch to continue");
      }
    }

    console.log(prevTouches[0] + " " + prevTouches[1] + " " + prevTouches[2]);
    console.log(ongoingTouches[0] + " " + ongoingTouches[1] + " " + ongoingTouches[2]);

    if(ongoingTouches.length == 1){
      prev_pt_1 = new Point(prevTouches[0].pageX, prevTouches[0].pageY);
      touch_pt_1 = new Point(ongoingTouches[0].pageX, ongoingTouches[0].pageY);
      var diff = touch_pt_1.subtract(prev_pt_1);
      raster.position = raster.position.add(diff);
    }

    if(ongoingTouches.length == 2){

      prev_pt_1 = new Point(prevTouches[0].pageX, prevTouches[0].pageY);
      prev_pt_2 = new Point(prevTouches[1].pageX, prevTouches[1].pageY);
      touch_pt_1 = new Point(ongoingTouches[0].pageX, ongoingTouches[0].pageY);
      touch_pt_2 = new Point(ongoingTouches[1].pageX, ongoingTouches[1].pageY);
      var vec_prev = prev_pt_1.subtract(prev_pt_2);
      var vec_new = touch_pt_1.subtract(touch_pt_2);

      // move the raster
      var midpt_prev = prev_pt_1.add(prev_pt_2).divide(2);
      var midpt_new = touch_pt_1.add(touch_pt_2).divide(2);

      var v1 = touch_pt_1.subtract(prev_pt_1);
      var v2 = touch_pt_2.subtract(prev_pt_2);
      var diff = v1.add(v2).divide(2);
      // var diff = midpt_new.subtract(midpt_prev);
      //var diff = raster.position.subtract(touch_pt_1);
      raster.position = raster.position.add(diff);//

      // scale the raster
      var d_scale = vec_new.length / vec_prev.length;
      raster.scale(d_scale, midpt_new);

      // rotate the raster
      var d_rot = vec_new.angle - vec_prev.angle;
      raster.rotate(d_rot,  midpt_new);
    }

  }

  function handleEnd(evt) {
    evt.preventDefault();
    console.log("touchend/touchleave.");
    var touches = evt.changedTouches;

    for (var i=0; i < touches.length; i++) {
      var idx = ongoingTouchIndexById(touches[i].identifier);

      if(idx >= 0) {
        prevTouches.splice(idx,1) //remove prev touch
        ongoingTouches.splice(idx, 1);  // remove it; we're done
      } else {
        console.log("can't figure out which touch to end");
      }

    }
  }

  function handleCancel(evt) {
    evt.preventDefault();
    var touches = evt.changedTouches;
    
    for (var i=0; i < touches.length; i++) {
      prevTouches.splice(i, 1) //remove prev touch
      ongoingTouches.splice(i, 1);  // remove it; we're done
    }
  }

  function copyTouch(touch) {
    return { identifier: touch.identifier, pageX: touch.pageX, pageY: touch.pageY };
  }

  function ongoingTouchIndexById(idToFind) {
    for (var i=0; i < ongoingTouches.length; i++) {
      var id = ongoingTouches[i].identifier;
      
      if (id == idToFind) {
        return i;
      }
    }
    return -1;    // not found
  }

</script>
</head>
<body>
  <canvas id="myCanvas" resize></canvas>
  <img id="test_img" style="display:none" src="peppers.jpg">
</body>
</html>